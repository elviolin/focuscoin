import React, { useState, useEffect, useMemo } from "react"
import { addPropertyControls, ControlType } from "framer"

// ============================================
// ë””ìì¸ ì‹œìŠ¤í…œ
// ============================================
const colors = {
    primary: "#3182F6",
    primaryLight: "#5B9BF7",
    primaryBg: "#EBF4FF",
    gray: {
        900: "#191F28",
        800: "#333D4B",
        700: "#4E5968",
        600: "#6B7684",
        500: "#8B95A1",
        400: "#B0B8C1",
        300: "#D1D6DB",
        200: "#E5E8EB",
        100: "#F2F4F6",
        50: "#F9FAFB",
        0: "#FFFFFF",
    },
    success: "#00C853",
    successBg: "#E8F5E9",
    warning: "#FF9100",
    warningBg: "#FFF3E0",
    error: "#F44336",
    errorBg: "#FFEBEE",
    purple: "#7C3AED",
    purpleBg: "#F3E8FF",
    cyan: "#06B6D4",
    cyanBg: "#ECFEFF",
}

const token = {
    font: {
        xs: 10,
        sm: 11,
        md: 12,
        lg: 13,
        xl: 14,
        xxl: 16,
        xxxl: 18,
        xxxxl: 22,
    },
    radius: { sm: 6, md: 8, lg: 10, xl: 12, xxl: 16, full: 9999 },
}

const globalStyles = `
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
* { box-sizing: border-box; margin: 0; padding: 0; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.hover-lift { transition: transform 0.15s, box-shadow 0.15s; }
.hover-lift:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: ${colors.gray[300]}; border-radius: 2px; }
@media print { .no-print { display: none !important; } }
`

// ============================================
// ì•„ì´ì½˜
// ============================================
const Icons = {
    dashboard: (
        <svg
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            strokeWidth="1.8"
            viewBox="0 0 24 24"
        >
            <rect x="3" y="3" width="7" height="7" rx="1" />
            <rect x="14" y="3" width="7" height="7" rx="1" />
            <rect x="3" y="14" width="7" height="7" rx="1" />
            <rect x="14" y="14" width="7" height="7" rx="1" />
        </svg>
    ),
    chart: (
        <svg
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            strokeWidth="1.8"
            viewBox="0 0 24 24"
        >
            <path d="M18 20V10M12 20V4M6 20v-6" />
        </svg>
    ),
    adType: (
        <svg
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            strokeWidth="1.8"
            viewBox="0 0 24 24"
        >
            <rect x="2" y="3" width="20" height="14" rx="2" />
            <path d="M8 21h8M12 17v4" />
        </svg>
    ),
    refresh: (
        <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <path d="M23 4v6h-6M1 20v-6h6" />
            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
        </svg>
    ),
    sparkle: (
        <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0L14.59 9.41L24 12L14.59 14.59L12 24L9.41 14.59L0 12L9.41 9.41L12 0Z" />
        </svg>
    ),
    close: (
        <svg
            width="20"
            height="20"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <path d="M18 6L6 18M6 6l12 12" />
        </svg>
    ),
    download: (
        <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
        </svg>
    ),
    reward: (
        <svg
            width="20"
            height="20"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <circle cx="12" cy="8" r="6" />
            <path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11" />
        </svg>
    ),
    banner: (
        <svg
            width="20"
            height="20"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <rect x="2" y="3" width="20" height="14" rx="2" />
            <path d="M8 21h8M12 17v4" />
        </svg>
    ),
    dollar: (
        <svg
            width="20"
            height="20"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />
        </svg>
    ),
    calendar: (
        <svg
            width="20"
            height="20"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            viewBox="0 0 24 24"
        >
            <rect x="3" y="4" width="18" height="18" rx="2" />
            <path d="M16 2v4M8 2v4M3 10h18" />
        </svg>
    ),
}

// ============================================
// ìœ í‹¸ë¦¬í‹°
// ============================================
const formatNumber = (num) => {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + "M"
    if (num >= 1000) return (num / 1000).toFixed(1) + "K"
    return num.toLocaleString()
}
const formatUSD = (num, d = 2) => "$" + num.toFixed(d)
const formatKRW = (num, rate) => "â‚©" + Math.round(num * rate).toLocaleString()

// ============================================
// ì‚¬ì´ë“œë°”
// ============================================
const MENU = [
    { id: "dashboard", label: "ëŒ€ì‹œë³´ë“œ", icon: Icons.dashboard },
    { id: "daily", label: "ì¼ë³„ ë¶„ì„", icon: Icons.chart },
    { id: "adtype", label: "ê´‘ê³  ìœ í˜•", icon: Icons.adType },
]

const Sidebar = ({ current, onNavigate }) => (
    <div
        style={{
            width: 200,
            minWidth: 200,
            height: "100vh",
            background: colors.gray[0],
            borderRight: `1px solid ${colors.gray[200]}`,
            display: "flex",
            flexDirection: "column",
        }}
    >
        <div style={{ padding: "20px 16px 16px" }}>
            <div
                style={{
                    fontSize: 15,
                    fontWeight: 700,
                    color: colors.gray[900],
                }}
            >
                FocusPlanet
            </div>
            <div style={{ fontSize: token.font.xs, color: colors.gray[500] }}>
                AdMob Dashboard
            </div>
        </div>
        <nav style={{ flex: 1, padding: "0 8px" }}>
            {MENU.map((item) => (
                <button
                    key={item.id}
                    onClick={() => onNavigate(item.id)}
                    style={{
                        width: "100%",
                        display: "flex",
                        alignItems: "center",
                        gap: 10,
                        padding: "12px 14px",
                        marginBottom: 2,
                        border: "none",
                        borderRadius: token.radius.md,
                        background:
                            current === item.id
                                ? colors.primaryBg
                                : "transparent",
                        cursor: "pointer",
                        textAlign: "left",
                        fontFamily: "Pretendard, sans-serif",
                    }}
                >
                    <div
                        style={{
                            color:
                                current === item.id
                                    ? colors.primary
                                    : colors.gray[400],
                        }}
                    >
                        {item.icon}
                    </div>
                    <span
                        style={{
                            fontSize: token.font.lg,
                            fontWeight: current === item.id ? 600 : 500,
                            color:
                                current === item.id
                                    ? colors.primary
                                    : colors.gray[700],
                        }}
                    >
                        {item.label}
                    </span>
                </button>
            ))}
        </nav>
    </div>
)

// ============================================
// ë¯¸ë‹ˆ ë¼ì¸ ì°¨íŠ¸ (ê· ì¼í•œ ì„ )
// ============================================
const MiniLineChart = ({ data, color = colors.primary, height = 100 }) => {
    if (!data || data.length < 2)
        return (
            <div
                style={{
                    height,
                    background: colors.gray[50],
                    borderRadius: token.radius.md,
                }}
            />
        )

    const values = data.map((d) => d.value)
    const max = Math.max(...values, 0.01)
    const min = Math.min(...values, 0)
    const range = max - min || 1

    const padding = 8
    const chartWidth = 100
    const chartHeight = height - padding * 2

    const points = values.map((v, i) => {
        const x =
            padding + (i / (values.length - 1)) * (chartWidth - padding * 2)
        const y = padding + chartHeight - ((v - min) / range) * chartHeight
        return { x, y }
    })

    const pathD = points
        .map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`)
        .join(" ")
    const areaD = `${pathD} L ${points[points.length - 1].x} ${height} L ${points[0].x} ${height} Z`

    return (
        <svg
            width="100%"
            height={height}
            viewBox={`0 0 ${chartWidth} ${height}`}
            preserveAspectRatio="none"
            style={{ display: "block" }}
        >
            <defs>
                <linearGradient
                    id={`area-${color.replace("#", "")}`}
                    x1="0%"
                    y1="0%"
                    x2="0%"
                    y2="100%"
                >
                    <stop offset="0%" stopColor={color} stopOpacity="0.25" />
                    <stop offset="100%" stopColor={color} stopOpacity="0.02" />
                </linearGradient>
            </defs>
            <path d={areaD} fill={`url(#area-${color.replace("#", "")})`} />
            <path
                d={pathD}
                fill="none"
                stroke={color}
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
                vectorEffect="non-scaling-stroke"
            />
        </svg>
    )
}

// ============================================
// ë°” ì°¨íŠ¸
// ============================================
const BarChart = ({ data, height = 140 }) => {
    if (!data || data.length === 0) return null
    const maxValue = Math.max(...data.map((d) => d.value), 0.01)

    return (
        <div
            style={{ display: "flex", alignItems: "flex-end", gap: 6, height }}
        >
            {data.map((item, idx) => {
                const barHeight = (item.value / maxValue) * (height - 45)
                return (
                    <div
                        key={idx}
                        style={{
                            flex: 1,
                            display: "flex",
                            flexDirection: "column",
                            alignItems: "center",
                            gap: 4,
                        }}
                    >
                        <div
                            style={{
                                fontSize: token.font.xs,
                                color: colors.gray[600],
                                fontWeight: 500,
                            }}
                        >
                            ${item.value.toFixed(2)}
                        </div>
                        <div
                            style={{
                                width: "100%",
                                height: height - 50,
                                display: "flex",
                                alignItems: "flex-end",
                            }}
                        >
                            <div
                                style={{
                                    width: "100%",
                                    height: Math.max(barHeight, 3),
                                    background: item.isToday
                                        ? colors.primary
                                        : colors.primaryBg,
                                    borderRadius: `${token.radius.sm}px ${token.radius.sm}px 0 0`,
                                }}
                            />
                        </div>
                        <div
                            style={{
                                fontSize: token.font.xs,
                                color: item.isToday
                                    ? colors.primary
                                    : colors.gray[500],
                                fontWeight: item.isToday ? 600 : 400,
                            }}
                        >
                            {item.label}
                        </div>
                    </div>
                )
            })}
        </div>
    )
}

// ============================================
// ë„ë„› ì°¨íŠ¸
// ============================================
const DonutChart = ({ data, size = 100 }) => {
    const total = data.reduce((sum, d) => sum + d.value, 0) || 1
    let currentAngle = -90

    const paths = data.map((item, idx) => {
        const percentage = item.value / total
        const angle = percentage * 360
        if (angle === 0) return null

        const startAngle = currentAngle
        const endAngle = currentAngle + angle
        currentAngle = endAngle

        const r = size / 2 - 12
        const cx = size / 2
        const cy = size / 2

        const startRad = (startAngle * Math.PI) / 180
        const endRad = (endAngle * Math.PI) / 180

        const x1 = cx + r * Math.cos(startRad)
        const y1 = cy + r * Math.sin(startRad)
        const x2 = cx + r * Math.cos(endRad)
        const y2 = cy + r * Math.sin(endRad)

        const largeArc = angle > 180 ? 1 : 0

        return (
            <path
                key={idx}
                d={`M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`}
                fill={item.color}
            />
        )
    })

    return (
        <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
            {paths}
            <circle
                cx={size / 2}
                cy={size / 2}
                r={size / 4}
                fill={colors.gray[0]}
            />
        </svg>
    )
}

// ============================================
// AI ì¸ì‚¬ì´íŠ¸ íŒì—…
// ============================================
const AIInsightModal = ({
    isOpen,
    onClose,
    stats,
    dailyData,
    exchangeRate,
}) => {
    const [loading, setLoading] = useState(false)
    const [report, setReport] = useState(null)

    useEffect(() => {
        if (isOpen && !report) {
            generateReport()
        }
    }, [isOpen])

    const generateReport = async () => {
        setLoading(true)
        await new Promise((r) => setTimeout(r, 1500))

        const today = dailyData[0] || { total: { revenue: 0, impressions: 0 } }
        const yesterday = dailyData[1] || {
            total: { revenue: 0, impressions: 0 },
        }
        const last7 = dailyData.slice(0, 7)
        const prev7 = dailyData.slice(7, 14)
        const last14 = dailyData.slice(0, 14)

        const todayRev = today.total.revenue
        const yesterdayRev = yesterday.total.revenue
        const dailyChange =
            yesterdayRev > 0
                ? ((todayRev - yesterdayRev) / yesterdayRev) * 100
                : 0

        const week1Avg =
            last7.reduce((s, d) => s + d.total.revenue, 0) /
            Math.max(last7.length, 1)
        const week2Avg =
            prev7.reduce((s, d) => s + d.total.revenue, 0) /
            Math.max(prev7.length, 1)
        const weeklyChange =
            week2Avg > 0 ? ((week1Avg - week2Avg) / week2Avg) * 100 : 0

        const todayEcpm =
            today.total.impressions > 0
                ? (today.total.revenue / today.total.impressions) * 1000
                : 0
        const yesterdayEcpm =
            yesterday.total.impressions > 0
                ? (yesterday.total.revenue / yesterday.total.impressions) * 1000
                : 0
        const ecpmChange =
            yesterdayEcpm > 0
                ? ((todayEcpm - yesterdayEcpm) / yesterdayEcpm) * 100
                : 0

        const rewardedRatio =
            stats.totalRevenue > 0
                ? ((stats.rewarded?.revenue || 0) / stats.totalRevenue) * 100
                : 0

        // ë¶„ì„ ë‚´ìš© ìƒì„±
        const insights = []
        const improvements = []
        const actions = []

        // ì¼ì¼ ë¶„ì„
        if (dailyChange > 10) {
            insights.push({
                type: "positive",
                title: "ì¼ì¼ ìˆ˜ìµ ìƒìŠ¹",
                desc: `ì „ì¼ ëŒ€ë¹„ ${dailyChange.toFixed(1)}% ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤. ë¦¬ì›Œë“œ ê´‘ê³  ë…¸ì¶œì´ ì¦ê°€í•œ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.`,
            })
        } else if (dailyChange < -10) {
            insights.push({
                type: "negative",
                title: "ì¼ì¼ ìˆ˜ìµ í•˜ë½",
                desc: `ì „ì¼ ëŒ€ë¹„ ${Math.abs(dailyChange).toFixed(1)}% í•˜ë½í–ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ì í™œì„±ë„ ê°ì†Œê°€ ì›ì¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
            })
            improvements.push("ì‚¬ìš©ì ë¦¬í…ì…˜ ìº í˜ì¸ì„ í†µí•´ DAUë¥¼ ë†’ì—¬ë³´ì„¸ìš”.")
        }

        // ì£¼ê°„ ë¶„ì„
        if (weeklyChange > 5) {
            insights.push({
                type: "positive",
                title: "ì£¼ê°„ ì„±ì¥ì„¸",
                desc: `ì§€ë‚œ 7ì¼ í‰ê· ì´ ì´ì „ ì£¼ ëŒ€ë¹„ ${weeklyChange.toFixed(1)}% ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.`,
            })
        } else if (weeklyChange < -5) {
            insights.push({
                type: "negative",
                title: "ì£¼ê°„ í•˜ë½ì„¸",
                desc: `ì§€ë‚œ 7ì¼ í‰ê· ì´ ì´ì „ ì£¼ ëŒ€ë¹„ ${Math.abs(weeklyChange).toFixed(1)}% í•˜ë½í–ˆìŠµë‹ˆë‹¤.`,
            })
            improvements.push("ê´‘ê³  ìœ„ì¹˜ ë° ë¹ˆë„ ìµœì í™”ë¥¼ ê²€í† í•´ë³´ì„¸ìš”.")
        }

        // eCPM ë¶„ì„
        if (ecpmChange > 5) {
            insights.push({
                type: "positive",
                title: "eCPM ìƒìŠ¹",
                desc: `eCPMì´ ${ecpmChange.toFixed(1)}% ìƒìŠ¹í•˜ì—¬ ê´‘ê³  ë‹¨ê°€ê°€ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.`,
            })
        } else if (ecpmChange < -5) {
            insights.push({
                type: "negative",
                title: "eCPM í•˜ë½",
                desc: `eCPMì´ ${Math.abs(ecpmChange).toFixed(1)}% í•˜ë½í–ˆìŠµë‹ˆë‹¤. ê´‘ê³  í’ˆì§ˆ ì ìˆ˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
            })
            improvements.push(
                "AdMob ë¯¸ë””ì—ì´ì…˜ ì„¤ì •ì„ ì ê²€í•˜ê³  fill rateë¥¼ í™•ì¸í•˜ì„¸ìš”."
            )
        }

        // ê´‘ê³  ìœ í˜• ë¶„ì„
        if (rewardedRatio > 80) {
            insights.push({
                type: "positive",
                title: "ë¦¬ì›Œë“œ ê´‘ê³  ì§‘ì¤‘",
                desc: `ìˆ˜ìµì˜ ${rewardedRatio.toFixed(0)}%ê°€ ë¦¬ì›Œë“œ ê´‘ê³ ì—ì„œ ë°œìƒí•˜ì—¬ ì•ˆì •ì ì…ë‹ˆë‹¤.`,
            })
        } else if (rewardedRatio < 50) {
            improvements.push("ë¦¬ì›Œë“œ ê´‘ê³  ë¹„ì¤‘ì„ ëŠ˜ë ¤ ìˆ˜ìµì„ ìµœì í™”í•˜ì„¸ìš”.")
        }

        // ì•¡ì…˜ ì•„ì´í…œ
        actions.push(
            "ì‚¬ìš©ì ì„¸ì…˜ ì‹œê°„ì´ ê¸´ ì‹œê°„ëŒ€(ì ì‹¬, ì €ë…)ì— ë¦¬ì›Œë“œ ê´‘ê³ ë¥¼ ì§‘ì¤‘ ë°°ì¹˜í•˜ì„¸ìš”."
        )
        actions.push(
            "ë°°ë„ˆ ê´‘ê³  ìœ„ì¹˜ë¥¼ ìŠ¤í¬ë¡¤ ì˜ì—­ í•˜ë‹¨ì—ì„œ ê³ ì • ì˜ì—­ìœ¼ë¡œ ë³€ê²½í•´ë³´ì„¸ìš”."
        )
        actions.push(
            "A/B í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë¦¬ì›Œë“œ ê´‘ê³  ë…¸ì¶œ íƒ€ì´ë°ì„ ìµœì í™”í•˜ì„¸ìš”."
        )
        if (todayEcpm < 3)
            actions.push(
                "AdMob ë¯¸ë””ì—ì´ì…˜ì— ì¶”ê°€ ë„¤íŠ¸ì›Œí¬(Unity Ads, AppLovin ë“±)ë¥¼ ì—°ë™í•˜ì„¸ìš”."
            )

        setReport({
            date: new Date().toLocaleDateString("ko-KR", {
                year: "numeric",
                month: "long",
                day: "numeric",
            }),
            metrics: {
                todayRev,
                yesterdayRev,
                dailyChange,
                week1Avg,
                week2Avg,
                weeklyChange,
                todayEcpm,
                ecpmChange,
                rewardedRatio,
            },
            insights,
            improvements,
            actions,
            forecast: week1Avg * 30,
        })
        setLoading(false)
    }

    const handlePrint = () => {
        window.print()
    }

    if (!isOpen) return null

    return (
        <div
            onClick={onClose}
            style={{
                position: "fixed",
                inset: 0,
                background: "rgba(0,0,0,0.5)",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                zIndex: 1000,
                animation: "fadeIn 0.2s ease",
            }}
        >
            <div
                onClick={(e) => e.stopPropagation()}
                style={{
                    width: "90%",
                    maxWidth: 700,
                    maxHeight: "90vh",
                    background: colors.gray[0],
                    borderRadius: token.radius.xxl,
                    overflow: "hidden",
                    display: "flex",
                    flexDirection: "column",
                }}
            >
                {/* í—¤ë” */}
                <div
                    className="no-print"
                    style={{
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "center",
                        padding: "16px 20px",
                        borderBottom: `1px solid ${colors.gray[200]}`,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                        }}
                    >
                        <div style={{ color: colors.primary }}>
                            {Icons.sparkle}
                        </div>
                        <span
                            style={{
                                fontSize: token.font.xxl,
                                fontWeight: 700,
                                color: colors.gray[900],
                            }}
                        >
                            AI ì„±ê³¼ ë¶„ì„ ë¦¬í¬íŠ¸
                        </span>
                    </div>
                    <div style={{ display: "flex", gap: 8 }}>
                        {report && (
                            <button
                                onClick={handlePrint}
                                style={{
                                    display: "flex",
                                    alignItems: "center",
                                    gap: 4,
                                    padding: "8px 14px",
                                    background: colors.gray[100],
                                    border: "none",
                                    borderRadius: token.radius.md,
                                    color: colors.gray[700],
                                    fontSize: token.font.md,
                                    fontWeight: 500,
                                    cursor: "pointer",
                                }}
                            >
                                {Icons.download} PDF ì €ì¥
                            </button>
                        )}
                        <button
                            onClick={onClose}
                            style={{
                                background: "none",
                                border: "none",
                                cursor: "pointer",
                                color: colors.gray[400],
                                padding: 4,
                            }}
                        >
                            {Icons.close}
                        </button>
                    </div>
                </div>

                {/* ì»¨í…ì¸  */}
                <div style={{ flex: 1, overflowY: "auto", padding: 24 }}>
                    {loading ? (
                        <div
                            style={{
                                display: "flex",
                                flexDirection: "column",
                                alignItems: "center",
                                justifyContent: "center",
                                padding: 60,
                            }}
                        >
                            <div
                                style={{
                                    width: 48,
                                    height: 48,
                                    border: `3px solid ${colors.gray[200]}`,
                                    borderTopColor: colors.primary,
                                    borderRadius: "50%",
                                    animation: "spin 1s linear infinite",
                                    marginBottom: 16,
                                }}
                            />
                            <div
                                style={{
                                    fontSize: token.font.lg,
                                    color: colors.gray[600],
                                }}
                            >
                                ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                            </div>
                        </div>
                    ) : (
                        report && (
                            <div
                                style={{
                                    display: "flex",
                                    flexDirection: "column",
                                    gap: 24,
                                }}
                            >
                                {/* ë¦¬í¬íŠ¸ í—¤ë” */}
                                <div
                                    style={{
                                        textAlign: "center",
                                        paddingBottom: 20,
                                        borderBottom: `1px solid ${colors.gray[200]}`,
                                    }}
                                >
                                    <div
                                        style={{
                                            fontSize: token.font.sm,
                                            color: colors.gray[500],
                                            marginBottom: 4,
                                        }}
                                    >
                                        FocusPlanet AdMob ì„±ê³¼ ë¶„ì„
                                    </div>
                                    <div
                                        style={{
                                            fontSize: token.font.xxxl,
                                            fontWeight: 700,
                                            color: colors.gray[900],
                                        }}
                                    >
                                        {report.date} ë¦¬í¬íŠ¸
                                    </div>
                                </div>

                                {/* í•µì‹¬ ì§€í‘œ ìš”ì•½ */}
                                <div>
                                    <h3
                                        style={{
                                            fontSize: token.font.lg,
                                            fontWeight: 600,
                                            color: colors.gray[900],
                                            marginBottom: 12,
                                        }}
                                    >
                                        ğŸ“Š í•µì‹¬ ì§€í‘œ ìš”ì•½
                                    </h3>
                                    <div
                                        style={{
                                            display: "grid",
                                            gridTemplateColumns: "1fr 1fr 1fr",
                                            gap: 12,
                                        }}
                                    >
                                        <div
                                            style={{
                                                padding: 16,
                                                background: colors.primaryBg,
                                                borderRadius: token.radius.lg,
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontSize: token.font.sm,
                                                    color: colors.primary,
                                                    marginBottom: 4,
                                                }}
                                            >
                                                ì˜¤ëŠ˜ ìˆ˜ìµ
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xxl,
                                                    fontWeight: 700,
                                                    color: colors.gray[900],
                                                }}
                                            >
                                                {formatUSD(
                                                    report.metrics.todayRev
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.sm,
                                                    color: colors.primary,
                                                }}
                                            >
                                                {formatKRW(
                                                    report.metrics.todayRev,
                                                    exchangeRate
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color:
                                                        report.metrics
                                                            .dailyChange >= 0
                                                            ? colors.success
                                                            : colors.error,
                                                    marginTop: 4,
                                                }}
                                            >
                                                ì „ì¼ ëŒ€ë¹„{" "}
                                                {report.metrics.dailyChange >= 0
                                                    ? "+"
                                                    : ""}
                                                {report.metrics.dailyChange.toFixed(
                                                    1
                                                )}
                                                %
                                            </div>
                                        </div>
                                        <div
                                            style={{
                                                padding: 16,
                                                background: colors.gray[50],
                                                borderRadius: token.radius.lg,
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontSize: token.font.sm,
                                                    color: colors.gray[500],
                                                    marginBottom: 4,
                                                }}
                                            >
                                                ì£¼ê°„ í‰ê· 
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xxl,
                                                    fontWeight: 700,
                                                    color: colors.gray[900],
                                                }}
                                            >
                                                {formatUSD(
                                                    report.metrics.week1Avg
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.sm,
                                                    color: colors.gray[600],
                                                }}
                                            >
                                                {formatKRW(
                                                    report.metrics.week1Avg,
                                                    exchangeRate
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color:
                                                        report.metrics
                                                            .weeklyChange >= 0
                                                            ? colors.success
                                                            : colors.error,
                                                    marginTop: 4,
                                                }}
                                            >
                                                ì „ì£¼ ëŒ€ë¹„{" "}
                                                {report.metrics.weeklyChange >=
                                                0
                                                    ? "+"
                                                    : ""}
                                                {report.metrics.weeklyChange.toFixed(
                                                    1
                                                )}
                                                %
                                            </div>
                                        </div>
                                        <div
                                            style={{
                                                padding: 16,
                                                background: colors.gray[50],
                                                borderRadius: token.radius.lg,
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontSize: token.font.sm,
                                                    color: colors.gray[500],
                                                    marginBottom: 4,
                                                }}
                                            >
                                                eCPM
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xxl,
                                                    fontWeight: 700,
                                                    color: colors.gray[900],
                                                }}
                                            >
                                                {formatUSD(
                                                    report.metrics.todayEcpm
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.sm,
                                                    color: colors.gray[600],
                                                }}
                                            >
                                                {formatKRW(
                                                    report.metrics.todayEcpm,
                                                    exchangeRate
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color:
                                                        report.metrics
                                                            .ecpmChange >= 0
                                                            ? colors.success
                                                            : colors.error,
                                                    marginTop: 4,
                                                }}
                                            >
                                                ì „ì¼ ëŒ€ë¹„{" "}
                                                {report.metrics.ecpmChange >= 0
                                                    ? "+"
                                                    : ""}
                                                {report.metrics.ecpmChange.toFixed(
                                                    1
                                                )}
                                                %
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* ì¸ì‚¬ì´íŠ¸ */}
                                <div>
                                    <h3
                                        style={{
                                            fontSize: token.font.lg,
                                            fontWeight: 600,
                                            color: colors.gray[900],
                                            marginBottom: 12,
                                        }}
                                    >
                                        ğŸ’¡ ì£¼ìš” ì¸ì‚¬ì´íŠ¸
                                    </h3>
                                    <div
                                        style={{
                                            display: "flex",
                                            flexDirection: "column",
                                            gap: 10,
                                        }}
                                    >
                                        {report.insights.length > 0 ? (
                                            report.insights.map((item, i) => (
                                                <div
                                                    key={i}
                                                    style={{
                                                        padding: 14,
                                                        background:
                                                            item.type ===
                                                            "positive"
                                                                ? colors.successBg
                                                                : colors.errorBg,
                                                        borderRadius:
                                                            token.radius.lg,
                                                        borderLeft: `4px solid ${item.type === "positive" ? colors.success : colors.error}`,
                                                    }}
                                                >
                                                    <div
                                                        style={{
                                                            fontSize:
                                                                token.font.md,
                                                            fontWeight: 600,
                                                            color: colors
                                                                .gray[900],
                                                            marginBottom: 4,
                                                        }}
                                                    >
                                                        {item.title}
                                                    </div>
                                                    <div
                                                        style={{
                                                            fontSize:
                                                                token.font.md,
                                                            color: colors
                                                                .gray[700],
                                                            lineHeight: 1.5,
                                                        }}
                                                    >
                                                        {item.desc}
                                                    </div>
                                                </div>
                                            ))
                                        ) : (
                                            <div
                                                style={{
                                                    padding: 14,
                                                    background: colors.gray[50],
                                                    borderRadius:
                                                        token.radius.lg,
                                                    color: colors.gray[600],
                                                    fontSize: token.font.md,
                                                }}
                                            >
                                                í˜„ì¬ ë°ì´í„°ë¡œëŠ” íŠ¹ë³„í•œ ë³€í™”ê°€
                                                ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* ê°œì„  ì‚¬í•­ */}
                                {report.improvements.length > 0 && (
                                    <div>
                                        <h3
                                            style={{
                                                fontSize: token.font.lg,
                                                fontWeight: 600,
                                                color: colors.gray[900],
                                                marginBottom: 12,
                                            }}
                                        >
                                            âš ï¸ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„
                                        </h3>
                                        <div
                                            style={{
                                                padding: 16,
                                                background: colors.warningBg,
                                                borderRadius: token.radius.lg,
                                            }}
                                        >
                                            <ul
                                                style={{
                                                    margin: 0,
                                                    paddingLeft: 20,
                                                    display: "flex",
                                                    flexDirection: "column",
                                                    gap: 8,
                                                }}
                                            >
                                                {report.improvements.map(
                                                    (item, i) => (
                                                        <li
                                                            key={i}
                                                            style={{
                                                                fontSize:
                                                                    token.font
                                                                        .md,
                                                                color: colors
                                                                    .gray[700],
                                                                lineHeight: 1.5,
                                                            }}
                                                        >
                                                            {item}
                                                        </li>
                                                    )
                                                )}
                                            </ul>
                                        </div>
                                    </div>
                                )}

                                {/* ì•¡ì…˜ ì•„ì´í…œ */}
                                <div>
                                    <h3
                                        style={{
                                            fontSize: token.font.lg,
                                            fontWeight: 600,
                                            color: colors.gray[900],
                                            marginBottom: 12,
                                        }}
                                    >
                                        âœ… ê¶Œì¥ ì•¡ì…˜ ì•„ì´í…œ
                                    </h3>
                                    <div
                                        style={{
                                            display: "flex",
                                            flexDirection: "column",
                                            gap: 8,
                                        }}
                                    >
                                        {report.actions.map((item, i) => (
                                            <div
                                                key={i}
                                                style={{
                                                    display: "flex",
                                                    alignItems: "flex-start",
                                                    gap: 10,
                                                    padding: 12,
                                                    background: colors.gray[50],
                                                    borderRadius:
                                                        token.radius.md,
                                                }}
                                            >
                                                <div
                                                    style={{
                                                        width: 22,
                                                        height: 22,
                                                        borderRadius: 11,
                                                        background:
                                                            colors.primary,
                                                        color: "#fff",
                                                        display: "flex",
                                                        alignItems: "center",
                                                        justifyContent:
                                                            "center",
                                                        fontSize: token.font.xs,
                                                        fontWeight: 600,
                                                        flexShrink: 0,
                                                    }}
                                                >
                                                    {i + 1}
                                                </div>
                                                <div
                                                    style={{
                                                        fontSize: token.font.md,
                                                        color: colors.gray[700],
                                                        lineHeight: 1.5,
                                                    }}
                                                >
                                                    {item}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* ì˜ˆì¸¡ */}
                                <div
                                    style={{
                                        padding: 20,
                                        background: `linear-gradient(135deg, ${colors.primary} 0%, ${colors.primaryLight} 100%)`,
                                        borderRadius: token.radius.xl,
                                        color: "#fff",
                                    }}
                                >
                                    <h3
                                        style={{
                                            fontSize: token.font.lg,
                                            fontWeight: 600,
                                            marginBottom: 8,
                                        }}
                                    >
                                        ğŸ“ˆ ì›”ê°„ ìˆ˜ìµ ì˜ˆì¸¡
                                    </h3>
                                    <div
                                        style={{
                                            fontSize: token.font.md,
                                            opacity: 0.9,
                                            lineHeight: 1.6,
                                        }}
                                    >
                                        í˜„ì¬ ì¶”ì„¸ê°€ ìœ ì§€ëœë‹¤ë©´, ì´ë²ˆ ë‹¬ ì˜ˆìƒ
                                        ìˆ˜ìµì€ ì•½{" "}
                                        <strong>
                                            {formatUSD(report.forecast)}
                                        </strong>{" "}
                                        (
                                        {formatKRW(
                                            report.forecast,
                                            exchangeRate
                                        )}
                                        ) ì…ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </div>
                        )
                    )}
                </div>
            </div>
        </div>
    )
}

// ============================================
// ë‚ ì§œ í¬ë§· í•¨ìˆ˜
// ============================================
const formatDateLabel = (dateStr) => {
    if (!dateStr) return ""
    const [year, month, day] = dateStr.split("-")
    return `${parseInt(month)}/${parseInt(day)}`
}

const formatDateFull = (dateStr) => {
    if (!dateStr) return ""
    const [year, month, day] = dateStr.split("-")
    return `${parseInt(month)}ì›” ${parseInt(day)}ì¼`
}

const isToday = (dateStr) => {
    if (!dateStr) return false
    const today = new Date()
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`
    return dateStr === todayStr
}

// ============================================
// ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
// ============================================
const DashboardPage = ({ stats, dailyData, exchangeRate, onOpenAI }) => {
    const latestData = dailyData[0] || {
        date: "",
        rewarded: { revenue: 0, impressions: 0 },
        banner: { revenue: 0, impressions: 0 },
        total: { revenue: 0 },
    }
    const latestDate = latestData.date || ""
    const isTodayData = isToday(latestDate)
    const monthAvg =
        dailyData.length > 0
            ? dailyData.reduce((s, d) => s + d.total.revenue, 0) /
              dailyData.length
            : 0

    const last7Days = dailyData.slice(0, 7).reverse()
    const chartData = last7Days.map((d, idx) => ({
        label: formatDateLabel(d.date),
        value: d.total.revenue,
        isToday: idx === last7Days.length - 1,
    }))

    const rewardedPerImp =
        latestData.rewarded.impressions > 0
            ? latestData.rewarded.revenue / latestData.rewarded.impressions
            : 0
    const bannerPerImp =
        latestData.banner.impressions > 0
            ? latestData.banner.revenue / latestData.banner.impressions
            : 0

    return (
        <div
            style={{
                display: "flex",
                flexDirection: "column",
                gap: 16,
                height: "100%",
                overflow: "hidden",
            }}
        >
            {/* í—¤ë” */}
            <div
                style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                }}
            >
                <div>
                    <h1
                        style={{
                            fontSize: token.font.xxxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                            marginBottom: 2,
                        }}
                    >
                        ëŒ€ì‹œë³´ë“œ
                    </h1>
                    <p
                        style={{
                            fontSize: token.font.md,
                            color: colors.gray[500],
                        }}
                    >
                        ìµœì‹  ë°ì´í„°:{" "}
                        <span
                            style={{ color: colors.primary, fontWeight: 600 }}
                        >
                            {latestDate}
                        </span>
                        {isTodayData && (
                            <span
                                style={{
                                    marginLeft: 6,
                                    padding: "2px 6px",
                                    background: colors.successBg,
                                    color: colors.success,
                                    borderRadius: token.radius.sm,
                                    fontSize: token.font.xs,
                                    fontWeight: 600,
                                }}
                            >
                                ì˜¤ëŠ˜
                            </span>
                        )}
                        {!isTodayData && (
                            <span
                                style={{
                                    marginLeft: 6,
                                    padding: "2px 6px",
                                    background: colors.warningBg,
                                    color: colors.warning,
                                    borderRadius: token.radius.sm,
                                    fontSize: token.font.xs,
                                    fontWeight: 500,
                                }}
                            >
                                ì–´ì œ
                            </span>
                        )}
                    </p>
                </div>
                <button
                    onClick={onOpenAI}
                    style={{
                        display: "flex",
                        alignItems: "center",
                        gap: 6,
                        padding: "10px 16px",
                        background: colors.primary,
                        color: "#fff",
                        border: "none",
                        borderRadius: token.radius.md,
                        fontSize: token.font.md,
                        fontWeight: 600,
                        cursor: "pointer",
                    }}
                >
                    {Icons.sparkle} AI ì¸ì‚¬ì´íŠ¸
                </button>
            </div>

            {/* KPI ì¹´ë“œ 4ê°œ */}
            <div
                style={{
                    display: "grid",
                    gridTemplateColumns: "repeat(4, 1fr)",
                    gap: 12,
                }}
            >
                {/* ë¦¬ì›Œë“œ ìˆ˜ìµ */}
                <div
                    className="hover-lift"
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 16,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                            marginBottom: 10,
                        }}
                    >
                        <div
                            style={{
                                width: 32,
                                height: 32,
                                borderRadius: token.radius.md,
                                background: colors.purpleBg,
                                color: colors.purple,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                            }}
                        >
                            {Icons.reward}
                        </div>
                        <div>
                            <span
                                style={{
                                    fontSize: token.font.md,
                                    color: colors.gray[600],
                                }}
                            >
                                ë¦¬ì›Œë“œ ìˆ˜ìµ
                            </span>
                            <span
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[400],
                                    marginLeft: 4,
                                }}
                            >
                                ({formatDateFull(latestDate)})
                            </span>
                        </div>
                    </div>
                    <div
                        style={{
                            fontSize: token.font.xxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                        }}
                    >
                        {formatUSD(latestData.rewarded.revenue)}
                    </div>
                    <div
                        style={{
                            fontSize: token.font.md,
                            fontWeight: 600,
                            color: colors.purple,
                        }}
                    >
                        {formatKRW(latestData.rewarded.revenue, exchangeRate)}
                    </div>
                    <div
                        style={{
                            fontSize: token.font.xs,
                            color: colors.gray[500],
                            marginTop: 6,
                        }}
                    >
                        ë…¸ì¶œ {formatNumber(latestData.rewarded.impressions)} Â·
                        1íšŒë‹¹ {formatKRW(rewardedPerImp, exchangeRate)}
                    </div>
                </div>

                {/* ë°°ë„ˆ ìˆ˜ìµ */}
                <div
                    className="hover-lift"
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 16,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                            marginBottom: 10,
                        }}
                    >
                        <div
                            style={{
                                width: 32,
                                height: 32,
                                borderRadius: token.radius.md,
                                background: colors.warningBg,
                                color: colors.warning,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                            }}
                        >
                            {Icons.banner}
                        </div>
                        <div>
                            <span
                                style={{
                                    fontSize: token.font.md,
                                    color: colors.gray[600],
                                }}
                            >
                                ë°°ë„ˆ ìˆ˜ìµ
                            </span>
                            <span
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[400],
                                    marginLeft: 4,
                                }}
                            >
                                ({formatDateFull(latestDate)})
                            </span>
                        </div>
                    </div>
                    <div
                        style={{
                            fontSize: token.font.xxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                        }}
                    >
                        {formatUSD(latestData.banner.revenue)}
                    </div>
                    <div
                        style={{
                            fontSize: token.font.md,
                            fontWeight: 600,
                            color: colors.warning,
                        }}
                    >
                        {formatKRW(latestData.banner.revenue, exchangeRate)}
                    </div>
                    <div
                        style={{
                            fontSize: token.font.xs,
                            color: colors.gray[500],
                            marginTop: 6,
                        }}
                    >
                        ë…¸ì¶œ {formatNumber(latestData.banner.impressions)} Â·
                        1íšŒë‹¹ {formatKRW(bannerPerImp, exchangeRate)}
                    </div>
                </div>

                {/* ì¼ ìˆ˜ìµ */}
                <div
                    className="hover-lift"
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 16,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                            marginBottom: 10,
                        }}
                    >
                        <div
                            style={{
                                width: 32,
                                height: 32,
                                borderRadius: token.radius.md,
                                background: colors.primaryBg,
                                color: colors.primary,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                            }}
                        >
                            {Icons.dollar}
                        </div>
                        <div>
                            <span
                                style={{
                                    fontSize: token.font.md,
                                    color: colors.gray[600],
                                }}
                            >
                                ì¼ ìˆ˜ìµ
                            </span>
                            <span
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[400],
                                    marginLeft: 4,
                                }}
                            >
                                ({formatDateFull(latestDate)})
                            </span>
                        </div>
                    </div>
                    <div
                        style={{
                            fontSize: token.font.xxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                        }}
                    >
                        {formatUSD(latestData.total.revenue)}
                    </div>
                    <div
                        style={{
                            fontSize: token.font.md,
                            fontWeight: 600,
                            color: colors.primary,
                        }}
                    >
                        {formatKRW(latestData.total.revenue, exchangeRate)}
                    </div>
                </div>

                {/* ì›” í‰ê·  ì¼ ìˆ˜ìµ */}
                <div
                    className="hover-lift"
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 16,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 8,
                            marginBottom: 10,
                        }}
                    >
                        <div
                            style={{
                                width: 32,
                                height: 32,
                                borderRadius: token.radius.md,
                                background: colors.successBg,
                                color: colors.success,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                            }}
                        >
                            {Icons.calendar}
                        </div>
                        <span
                            style={{
                                fontSize: token.font.md,
                                color: colors.gray[600],
                            }}
                        >
                            ì›” í‰ê·  ì¼ ìˆ˜ìµ
                        </span>
                    </div>
                    <div
                        style={{
                            fontSize: token.font.xxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                        }}
                    >
                        {formatUSD(monthAvg)}
                    </div>
                    <div
                        style={{
                            fontSize: token.font.md,
                            fontWeight: 600,
                            color: colors.success,
                        }}
                    >
                        {formatKRW(monthAvg, exchangeRate)}
                    </div>
                </div>
            </div>

            {/* ì°¨íŠ¸ 2ê°œ */}
            <div
                style={{
                    display: "grid",
                    gridTemplateColumns: "2fr 1fr",
                    gap: 12,
                    flex: "0 0 auto",
                }}
            >
                {/* ì¼ë³„ ìˆ˜ìµ ì¶”ì´ */}
                <div
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 16,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                            marginBottom: 12,
                        }}
                    >
                        <div>
                            <h3
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                ì¼ë³„ ìˆ˜ìµ ì¶”ì´
                            </h3>
                            <p
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                ìµœê·¼ 7ì¼
                            </p>
                        </div>
                        <div style={{ textAlign: "right" }}>
                            <div
                                style={{
                                    fontSize: token.font.xxl,
                                    fontWeight: 700,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatUSD(latestData.total.revenue)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.sm,
                                    color: colors.primary,
                                }}
                            >
                                {formatKRW(
                                    latestData.total.revenue,
                                    exchangeRate
                                )}
                            </div>
                        </div>
                    </div>
                    <BarChart data={chartData} height={130} />
                </div>

                {/* ê´‘ê³  ìœ í˜•ë³„ ìˆ˜ìµ */}
                <div
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 16,
                    }}
                >
                    <h3
                        style={{
                            fontSize: token.font.lg,
                            fontWeight: 600,
                            color: colors.gray[900],
                            marginBottom: 12,
                        }}
                    >
                        ê´‘ê³  ìœ í˜•ë³„ ìˆ˜ìµ
                    </h3>
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 16,
                        }}
                    >
                        <DonutChart
                            data={[
                                {
                                    value: stats.rewarded?.revenue || 0,
                                    color: colors.purple,
                                },
                                {
                                    value: stats.banner?.revenue || 0,
                                    color: colors.warning,
                                },
                            ]}
                            size={90}
                        />
                        <div
                            style={{
                                flex: 1,
                                display: "flex",
                                flexDirection: "column",
                                gap: 10,
                            }}
                        >
                            <div
                                style={{
                                    display: "flex",
                                    justifyContent: "space-between",
                                    alignItems: "center",
                                }}
                            >
                                <div
                                    style={{
                                        display: "flex",
                                        alignItems: "center",
                                        gap: 6,
                                    }}
                                >
                                    <div
                                        style={{
                                            width: 8,
                                            height: 8,
                                            borderRadius: 2,
                                            background: colors.purple,
                                        }}
                                    />
                                    <span
                                        style={{
                                            fontSize: token.font.sm,
                                            color: colors.gray[600],
                                        }}
                                    >
                                        ë¦¬ì›Œë“œ
                                    </span>
                                </div>
                                <div style={{ textAlign: "right" }}>
                                    <div
                                        style={{
                                            fontSize: token.font.md,
                                            fontWeight: 600,
                                            color: colors.gray[900],
                                        }}
                                    >
                                        {formatUSD(
                                            stats.rewarded?.revenue || 0
                                        )}
                                    </div>
                                    <div
                                        style={{
                                            fontSize: token.font.xs,
                                            color: colors.purple,
                                        }}
                                    >
                                        {formatKRW(
                                            stats.rewarded?.revenue || 0,
                                            exchangeRate
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div
                                style={{
                                    display: "flex",
                                    justifyContent: "space-between",
                                    alignItems: "center",
                                }}
                            >
                                <div
                                    style={{
                                        display: "flex",
                                        alignItems: "center",
                                        gap: 6,
                                    }}
                                >
                                    <div
                                        style={{
                                            width: 8,
                                            height: 8,
                                            borderRadius: 2,
                                            background: colors.warning,
                                        }}
                                    />
                                    <span
                                        style={{
                                            fontSize: token.font.sm,
                                            color: colors.gray[600],
                                        }}
                                    >
                                        ë°°ë„ˆ
                                    </span>
                                </div>
                                <div style={{ textAlign: "right" }}>
                                    <div
                                        style={{
                                            fontSize: token.font.md,
                                            fontWeight: 600,
                                            color: colors.gray[900],
                                        }}
                                    >
                                        {formatUSD(stats.banner?.revenue || 0)}
                                    </div>
                                    <div
                                        style={{
                                            fontSize: token.font.xs,
                                            color: colors.warning,
                                        }}
                                    >
                                        {formatKRW(
                                            stats.banner?.revenue || 0,
                                            exchangeRate
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* ìµœê·¼ 7ì¼ í˜„í™© í…Œì´ë¸” */}
            <div
                style={{
                    flex: 1,
                    minHeight: 0,
                    background: colors.gray[0],
                    borderRadius: token.radius.xl,
                    border: `1px solid ${colors.gray[200]}`,
                    overflow: "hidden",
                    display: "flex",
                    flexDirection: "column",
                }}
            >
                <div
                    style={{
                        padding: "12px 16px",
                        borderBottom: `1px solid ${colors.gray[200]}`,
                        flexShrink: 0,
                    }}
                >
                    <h3
                        style={{
                            fontSize: token.font.lg,
                            fontWeight: 600,
                            color: colors.gray[900],
                        }}
                    >
                        ìµœê·¼ 7ì¼ í˜„í™©
                    </h3>
                </div>
                <div style={{ flex: 1, overflowY: "auto" }}>
                    <table
                        style={{
                            width: "100%",
                            borderCollapse: "collapse",
                            fontSize: token.font.sm,
                        }}
                    >
                        <thead>
                            <tr style={{ background: colors.gray[50] }}>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "left",
                                        fontWeight: 600,
                                        color: colors.gray[600],
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë‚ ì§œ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë¦¬ì›Œë“œ ë…¸ì¶œ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë¦¬ì›Œë“œ í´ë¦­
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë¦¬ì›Œë“œ ìˆ˜ìµ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    eCPM
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë°°ë„ˆ ë…¸ì¶œ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë°°ë„ˆ í´ë¦­
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë°°ë„ˆ ìˆ˜ìµ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    eCPM
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {dailyData.slice(0, 7).map((row, idx) => {
                                const rEcpm =
                                    row.rewarded.impressions > 0
                                        ? (row.rewarded.revenue /
                                              row.rewarded.impressions) *
                                          1000
                                        : 0
                                const bEcpm =
                                    row.banner.impressions > 0
                                        ? (row.banner.revenue /
                                              row.banner.impressions) *
                                          1000
                                        : 0
                                return (
                                    <tr
                                        key={idx}
                                        style={{
                                            borderBottom: `1px solid ${colors.gray[100]}`,
                                        }}
                                    >
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                fontWeight: 500,
                                                color: colors.gray[900],
                                            }}
                                        >
                                            {row.date}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[700],
                                            }}
                                        >
                                            {formatNumber(
                                                row.rewarded.impressions
                                            )}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[700],
                                            }}
                                        >
                                            {formatNumber(row.rewarded.clicks)}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontWeight: 600,
                                                    color: colors.purple,
                                                }}
                                            >
                                                {formatUSD(
                                                    row.rewarded.revenue
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.gray[500],
                                                }}
                                            >
                                                {formatKRW(
                                                    row.rewarded.revenue,
                                                    exchangeRate
                                                )}
                                            </div>
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[600],
                                            }}
                                        >
                                            {formatUSD(rEcpm)}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[700],
                                            }}
                                        >
                                            {formatNumber(
                                                row.banner.impressions
                                            )}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[700],
                                            }}
                                        >
                                            {formatNumber(row.banner.clicks)}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontWeight: 600,
                                                    color: colors.warning,
                                                }}
                                            >
                                                {formatUSD(row.banner.revenue)}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.gray[500],
                                                }}
                                            >
                                                {formatKRW(
                                                    row.banner.revenue,
                                                    exchangeRate
                                                )}
                                            </div>
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[600],
                                            }}
                                        >
                                            {formatUSD(bEcpm)}
                                        </td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    )
}

// ============================================
// ì¼ë³„ ë¶„ì„ í˜ì´ì§€
// ============================================
const DailyPage = ({ dailyData, exchangeRate }) => {
    const [range, setRange] = useState(14)
    const displayData = dailyData.slice(0, range)
    const lineData = displayData
        .map((d) => ({ value: d.total.revenue }))
        .reverse()

    return (
        <div
            style={{
                display: "flex",
                flexDirection: "column",
                gap: 16,
                height: "100%",
                overflow: "hidden",
            }}
        >
            <div
                style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                }}
            >
                <div>
                    <h1
                        style={{
                            fontSize: token.font.xxxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                            marginBottom: 2,
                        }}
                    >
                        ì¼ë³„ ë¶„ì„
                    </h1>
                    <p
                        style={{
                            fontSize: token.font.md,
                            color: colors.gray[500],
                        }}
                    >
                        ì¼ìë³„ ìƒì„¸ ìˆ˜ìµ ë°ì´í„°
                    </p>
                </div>
                <div style={{ display: "flex", gap: 6 }}>
                    {[7, 14, 30].map((n) => (
                        <button
                            key={n}
                            onClick={() => setRange(n)}
                            style={{
                                padding: "6px 14px",
                                borderRadius: token.radius.md,
                                border: `1px solid ${range === n ? colors.primary : colors.gray[200]}`,
                                background:
                                    range === n
                                        ? colors.primaryBg
                                        : colors.gray[0],
                                color:
                                    range === n
                                        ? colors.primary
                                        : colors.gray[600],
                                fontSize: token.font.md,
                                fontWeight: 500,
                                cursor: "pointer",
                            }}
                        >
                            {n}ì¼
                        </button>
                    ))}
                </div>
            </div>

            <div
                style={{
                    background: colors.gray[0],
                    borderRadius: token.radius.xl,
                    border: `1px solid ${colors.gray[200]}`,
                    padding: 16,
                }}
            >
                <h3
                    style={{
                        fontSize: token.font.lg,
                        fontWeight: 600,
                        color: colors.gray[900],
                        marginBottom: 12,
                    }}
                >
                    ìˆ˜ìµ íŠ¸ë Œë“œ
                </h3>
                <MiniLineChart
                    data={lineData}
                    color={colors.primary}
                    height={120}
                />
            </div>

            <div
                style={{
                    flex: 1,
                    minHeight: 0,
                    background: colors.gray[0],
                    borderRadius: token.radius.xl,
                    border: `1px solid ${colors.gray[200]}`,
                    overflow: "hidden",
                    display: "flex",
                    flexDirection: "column",
                }}
            >
                <div style={{ flex: 1, overflowY: "auto" }}>
                    <table
                        style={{
                            width: "100%",
                            borderCollapse: "collapse",
                            fontSize: token.font.sm,
                        }}
                    >
                        <thead>
                            <tr style={{ background: colors.gray[50] }}>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "left",
                                        fontWeight: 600,
                                        color: colors.gray[600],
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë‚ ì§œ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë¦¬ì›Œë“œ ë…¸ì¶œ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë¦¬ì›Œë“œ ìˆ˜ìµ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.purple,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    1íšŒë‹¹
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë°°ë„ˆ ë…¸ì¶œ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ë°°ë„ˆ ìˆ˜ìµ
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.warning,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    1íšŒë‹¹
                                </th>
                                <th
                                    style={{
                                        padding: "10px 12px",
                                        textAlign: "right",
                                        fontWeight: 600,
                                        color: colors.primary,
                                        position: "sticky",
                                        top: 0,
                                        background: colors.gray[50],
                                    }}
                                >
                                    ì´ ìˆ˜ìµ
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {displayData.map((row, idx) => {
                                const rPer =
                                    row.rewarded.impressions > 0
                                        ? row.rewarded.revenue /
                                          row.rewarded.impressions
                                        : 0
                                const bPer =
                                    row.banner.impressions > 0
                                        ? row.banner.revenue /
                                          row.banner.impressions
                                        : 0
                                return (
                                    <tr
                                        key={idx}
                                        style={{
                                            borderBottom: `1px solid ${colors.gray[100]}`,
                                        }}
                                    >
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                fontWeight: 500,
                                                color: colors.gray[900],
                                            }}
                                        >
                                            {row.date}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[700],
                                            }}
                                        >
                                            {formatNumber(
                                                row.rewarded.impressions
                                            )}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontWeight: 600,
                                                    color: colors.purple,
                                                }}
                                            >
                                                {formatUSD(
                                                    row.rewarded.revenue
                                                )}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.gray[500],
                                                }}
                                            >
                                                (
                                                {formatKRW(
                                                    row.rewarded.revenue,
                                                    exchangeRate
                                                )}
                                                )
                                            </div>
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    color: colors.gray[600],
                                                }}
                                            >
                                                {formatUSD(rPer, 4)}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.gray[500],
                                                }}
                                            >
                                                ({formatKRW(rPer, exchangeRate)}
                                                )
                                            </div>
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                                color: colors.gray[700],
                                            }}
                                        >
                                            {formatNumber(
                                                row.banner.impressions
                                            )}
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontWeight: 600,
                                                    color: colors.warning,
                                                }}
                                            >
                                                {formatUSD(row.banner.revenue)}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.gray[500],
                                                }}
                                            >
                                                (
                                                {formatKRW(
                                                    row.banner.revenue,
                                                    exchangeRate
                                                )}
                                                )
                                            </div>
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    color: colors.gray[600],
                                                }}
                                            >
                                                {formatUSD(bPer, 4)}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.gray[500],
                                                }}
                                            >
                                                ({formatKRW(bPer, exchangeRate)}
                                                )
                                            </div>
                                        </td>
                                        <td
                                            style={{
                                                padding: "10px 12px",
                                                textAlign: "right",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    fontWeight: 700,
                                                    color: colors.gray[900],
                                                }}
                                            >
                                                {formatUSD(row.total.revenue)}
                                            </div>
                                            <div
                                                style={{
                                                    fontSize: token.font.xs,
                                                    color: colors.primary,
                                                }}
                                            >
                                                (
                                                {formatKRW(
                                                    row.total.revenue,
                                                    exchangeRate
                                                )}
                                                )
                                            </div>
                                        </td>
                                    </tr>
                                )
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    )
}

// ============================================
// ê´‘ê³  ìœ í˜• í˜ì´ì§€
// ============================================
const AdTypePage = ({ stats, dailyData, exchangeRate }) => {
    const [period, setPeriod] = useState(7)

    const periodData = dailyData.slice(0, period)
    const rewardedTrend = periodData
        .map((d) => ({ value: d.rewarded.revenue }))
        .reverse()
    const bannerTrend = periodData
        .map((d) => ({ value: d.banner.revenue }))
        .reverse()

    const periodStats = {
        rewarded: {
            revenue: periodData.reduce((s, d) => s + d.rewarded.revenue, 0),
            impressions: periodData.reduce(
                (s, d) => s + d.rewarded.impressions,
                0
            ),
        },
        banner: {
            revenue: periodData.reduce((s, d) => s + d.banner.revenue, 0),
            impressions: periodData.reduce(
                (s, d) => s + d.banner.impressions,
                0
            ),
        },
    }

    const rewardedPerImp =
        periodStats.rewarded.impressions > 0
            ? periodStats.rewarded.revenue / periodStats.rewarded.impressions
            : 0
    const bannerPerImp =
        periodStats.banner.impressions > 0
            ? periodStats.banner.revenue / periodStats.banner.impressions
            : 0
    const rewardedEcpm =
        periodStats.rewarded.impressions > 0
            ? (periodStats.rewarded.revenue /
                  periodStats.rewarded.impressions) *
              1000
            : 0
    const bannerEcpm =
        periodStats.banner.impressions > 0
            ? (periodStats.banner.revenue / periodStats.banner.impressions) *
              1000
            : 0

    return (
        <div
            style={{
                display: "flex",
                flexDirection: "column",
                gap: 16,
                height: "100%",
                overflow: "auto",
            }}
        >
            <div
                style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                }}
            >
                <div>
                    <h1
                        style={{
                            fontSize: token.font.xxxl,
                            fontWeight: 700,
                            color: colors.gray[900],
                            marginBottom: 2,
                        }}
                    >
                        ê´‘ê³  ìœ í˜•ë³„ ë¶„ì„
                    </h1>
                    <p
                        style={{
                            fontSize: token.font.md,
                            color: colors.gray[500],
                        }}
                    >
                        ë¦¬ì›Œë“œ ê´‘ê³ ì™€ ë°°ë„ˆ ê´‘ê³  ì„±ê³¼ ë¹„êµ
                    </p>
                </div>
                <div style={{ display: "flex", gap: 6 }}>
                    {[1, 7, 14, 30].map((n) => (
                        <button
                            key={n}
                            onClick={() => setPeriod(n)}
                            style={{
                                padding: "6px 14px",
                                borderRadius: token.radius.md,
                                border: `1px solid ${period === n ? colors.primary : colors.gray[200]}`,
                                background:
                                    period === n
                                        ? colors.primaryBg
                                        : colors.gray[0],
                                color:
                                    period === n
                                        ? colors.primary
                                        : colors.gray[600],
                                fontSize: token.font.md,
                                fontWeight: 500,
                                cursor: "pointer",
                            }}
                        >
                            {n === 1 ? "1ì¼" : `${n}ì¼`}
                        </button>
                    ))}
                </div>
            </div>

            <div
                style={{
                    display: "grid",
                    gridTemplateColumns: "1fr 1fr",
                    gap: 12,
                }}
            >
                {/* ë¦¬ì›Œë“œ */}
                <div
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 20,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 10,
                            marginBottom: 16,
                        }}
                    >
                        <div
                            style={{
                                width: 36,
                                height: 36,
                                borderRadius: token.radius.md,
                                background: colors.purpleBg,
                                color: colors.purple,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                            }}
                        >
                            {Icons.reward}
                        </div>
                        <div>
                            <h3
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                ë¦¬ì›Œë“œ ê´‘ê³ 
                            </h3>
                            <p
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                ì‚¬ìš©ì ë³´ìƒí˜• ê´‘ê³ 
                            </p>
                        </div>
                    </div>
                    <div
                        style={{
                            display: "grid",
                            gridTemplateColumns: "1fr 1fr",
                            gap: 10,
                            marginBottom: 16,
                        }}
                    >
                        <div
                            style={{
                                padding: 12,
                                background: colors.purpleBg,
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.purple,
                                    marginBottom: 2,
                                }}
                            >
                                ì´ ìˆ˜ìµ
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xxl,
                                    fontWeight: 700,
                                    color: colors.purple,
                                }}
                            >
                                {formatUSD(periodStats.rewarded.revenue)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.sm,
                                    color: colors.purple,
                                }}
                            >
                                {formatKRW(
                                    periodStats.rewarded.revenue,
                                    exchangeRate
                                )}
                            </div>
                        </div>
                        <div
                            style={{
                                padding: 12,
                                background: colors.gray[50],
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                    marginBottom: 2,
                                }}
                            >
                                ë…¸ì¶œìˆ˜
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xxl,
                                    fontWeight: 700,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatNumber(periodStats.rewarded.impressions)}
                            </div>
                        </div>
                        <div
                            style={{
                                padding: 12,
                                background: colors.gray[50],
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                    marginBottom: 2,
                                }}
                            >
                                1íšŒë‹¹ ìˆ˜ìµ
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatUSD(rewardedPerImp, 4)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                {formatKRW(rewardedPerImp, exchangeRate)}
                            </div>
                        </div>
                        <div
                            style={{
                                padding: 12,
                                background: colors.gray[50],
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                    marginBottom: 2,
                                }}
                            >
                                eCPM
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatUSD(rewardedEcpm)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                {formatKRW(rewardedEcpm, exchangeRate)}
                            </div>
                        </div>
                    </div>
                    {period > 1 && (
                        <>
                            <div
                                style={{
                                    fontSize: token.font.sm,
                                    color: colors.gray[500],
                                    marginBottom: 8,
                                }}
                            >
                                {period}ì¼ ì¶”ì´
                            </div>
                            <MiniLineChart
                                data={rewardedTrend}
                                color={colors.purple}
                                height={80}
                            />
                        </>
                    )}
                </div>

                {/* ë°°ë„ˆ */}
                <div
                    style={{
                        background: colors.gray[0],
                        borderRadius: token.radius.xl,
                        border: `1px solid ${colors.gray[200]}`,
                        padding: 20,
                    }}
                >
                    <div
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 10,
                            marginBottom: 16,
                        }}
                    >
                        <div
                            style={{
                                width: 36,
                                height: 36,
                                borderRadius: token.radius.md,
                                background: colors.warningBg,
                                color: colors.warning,
                                display: "flex",
                                alignItems: "center",
                                justifyContent: "center",
                            }}
                        >
                            {Icons.banner}
                        </div>
                        <div>
                            <h3
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                ë°°ë„ˆ ê´‘ê³ 
                            </h3>
                            <p
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                í™”ë©´ ë‚´ ë…¸ì¶œ ê´‘ê³ 
                            </p>
                        </div>
                    </div>
                    <div
                        style={{
                            display: "grid",
                            gridTemplateColumns: "1fr 1fr",
                            gap: 10,
                            marginBottom: 16,
                        }}
                    >
                        <div
                            style={{
                                padding: 12,
                                background: colors.warningBg,
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.warning,
                                    marginBottom: 2,
                                }}
                            >
                                ì´ ìˆ˜ìµ
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xxl,
                                    fontWeight: 700,
                                    color: colors.warning,
                                }}
                            >
                                {formatUSD(periodStats.banner.revenue)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.sm,
                                    color: colors.warning,
                                }}
                            >
                                {formatKRW(
                                    periodStats.banner.revenue,
                                    exchangeRate
                                )}
                            </div>
                        </div>
                        <div
                            style={{
                                padding: 12,
                                background: colors.gray[50],
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                    marginBottom: 2,
                                }}
                            >
                                ë…¸ì¶œìˆ˜
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xxl,
                                    fontWeight: 700,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatNumber(periodStats.banner.impressions)}
                            </div>
                        </div>
                        <div
                            style={{
                                padding: 12,
                                background: colors.gray[50],
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                    marginBottom: 2,
                                }}
                            >
                                1íšŒë‹¹ ìˆ˜ìµ
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatUSD(bannerPerImp, 4)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                {formatKRW(bannerPerImp, exchangeRate)}
                            </div>
                        </div>
                        <div
                            style={{
                                padding: 12,
                                background: colors.gray[50],
                                borderRadius: token.radius.lg,
                            }}
                        >
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                    marginBottom: 2,
                                }}
                            >
                                eCPM
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.lg,
                                    fontWeight: 600,
                                    color: colors.gray[900],
                                }}
                            >
                                {formatUSD(bannerEcpm)}
                            </div>
                            <div
                                style={{
                                    fontSize: token.font.xs,
                                    color: colors.gray[500],
                                }}
                            >
                                {formatKRW(bannerEcpm, exchangeRate)}
                            </div>
                        </div>
                    </div>
                    {period > 1 && (
                        <>
                            <div
                                style={{
                                    fontSize: token.font.sm,
                                    color: colors.gray[500],
                                    marginBottom: 8,
                                }}
                            >
                                {period}ì¼ ì¶”ì´
                            </div>
                            <MiniLineChart
                                data={bannerTrend}
                                color={colors.warning}
                                height={80}
                            />
                        </>
                    )}
                </div>
            </div>
        </div>
    )
}

// ============================================
// ë©”ì¸ ì»´í¬ë„ŒíŠ¸
// ============================================
export default function FocusPlanetDashboard({ apiUrl, exchangeRate = 1450 }) {
    const [page, setPage] = useState("dashboard")
    const [data, setData] = useState(null)
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState(null)
    const [showAI, setShowAI] = useState(false)
    const [refreshing, setRefreshing] = useState(false)
    const [lastUpdated, setLastUpdated] = useState(null)

    useEffect(() => {
        const style = document.createElement("style")
        style.textContent = globalStyles
        document.head.appendChild(style)
        return () => document.head.removeChild(style)
    }, [])

    const fetchData = async () => {
        if (!apiUrl) {
            setError("API URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”")
            setLoading(false)
            return
        }
        setLoading(true)
        setError(null)
        try {
            const res = await fetch(apiUrl)
            const result = await res.json()
            if (result.error) throw new Error(result.error)
            setData(result)
            setLastUpdated(result.lastUpdated)
        } catch (e) {
            setError(e.message)
        } finally {
            setLoading(false)
        }
    }

    // â˜… ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (AdMob API ìƒˆë¡œ í˜¸ì¶œ)
    const fetchLatestData = async () => {
        if (!apiUrl || refreshing) return
        setRefreshing(true)
        try {
            const res = await fetch(`${apiUrl}?action=refresh`)
            const result = await res.json()
            if (result.error) throw new Error(result.error)
            setData(result)
            setLastUpdated(result.refreshedAt || result.lastUpdated)
        } catch (e) {
            console.error("ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:", e.message)
        } finally {
            setRefreshing(false)
        }
    }

    useEffect(() => {
        fetchData()
    }, [apiUrl])

    const processedData = useMemo(() => {
        if (!data?.data)
            return {
                stats: {
                    rewarded: { impressions: 0, revenue: 0, clicks: 0 },
                    banner: { impressions: 0, revenue: 0, clicks: 0 },
                    totalRevenue: 0,
                    totalImpressions: 0,
                },
                dailyData: [],
            }

        const stats = {
            rewarded: { impressions: 0, revenue: 0, clicks: 0 },
            banner: { impressions: 0, revenue: 0, clicks: 0 },
            totalRevenue: data.summary?.totalRevenue || 0,
            totalImpressions: data.summary?.totalImpressions || 0,
        }

        data.data.forEach((row) => {
            const format = (row.ad_format || "").toLowerCase()
            if (format.includes("reward")) {
                stats.rewarded.impressions += row.impressions || 0
                stats.rewarded.revenue += row.revenue || 0
                stats.rewarded.clicks += row.clicks || 0
            } else {
                stats.banner.impressions += row.impressions || 0
                stats.banner.revenue += row.revenue || 0
                stats.banner.clicks += row.clicks || 0
            }
        })

        const dailyMap = {}
        data.data.forEach((row) => {
            const date =
                typeof row.date === "string"
                    ? row.date.slice(0, 10)
                    : new Date(row.date).toISOString().slice(0, 10)
            if (!dailyMap[date])
                dailyMap[date] = {
                    rewarded: { impressions: 0, revenue: 0, clicks: 0 },
                    banner: { impressions: 0, revenue: 0, clicks: 0 },
                }
            const format = (row.ad_format || "").toLowerCase()
            const target = format.includes("reward")
                ? dailyMap[date].rewarded
                : dailyMap[date].banner
            target.impressions += row.impressions || 0
            target.revenue += row.revenue || 0
            target.clicks += row.clicks || 0
        })

        const dailyData = Object.entries(dailyMap)
            .map(([date, d]) => ({
                date,
                ...d,
                total: {
                    impressions: d.rewarded.impressions + d.banner.impressions,
                    revenue: d.rewarded.revenue + d.banner.revenue,
                    clicks: d.rewarded.clicks + d.banner.clicks,
                },
            }))
            .sort((a, b) => b.date.localeCompare(a.date))

        return { stats, dailyData }
    }, [data])

    if (loading)
        return (
            <div
                style={{
                    width: "100%",
                    height: "100vh",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    background: colors.gray[50],
                    fontFamily: "Pretendard",
                }}
            >
                <div
                    style={{
                        width: 40,
                        height: 40,
                        border: `3px solid ${colors.gray[200]}`,
                        borderTopColor: colors.primary,
                        borderRadius: "50%",
                        animation: "spin 1s linear infinite",
                    }}
                />
            </div>
        )

    if (error)
        return (
            <div
                style={{
                    width: "100%",
                    height: "100vh",
                    display: "flex",
                    flexDirection: "column",
                    alignItems: "center",
                    justifyContent: "center",
                    background: colors.gray[50],
                    fontFamily: "Pretendard",
                    gap: 12,
                }}
            >
                <div style={{ fontSize: 40 }}>âš ï¸</div>
                <div
                    style={{
                        fontSize: token.font.lg,
                        fontWeight: 600,
                        color: colors.gray[700],
                    }}
                >
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
                </div>
                <div
                    style={{ fontSize: token.font.md, color: colors.gray[500] }}
                >
                    {error}
                </div>
                <button
                    onClick={fetchData}
                    style={{
                        marginTop: 8,
                        padding: "10px 20px",
                        background: colors.primary,
                        color: "#fff",
                        border: "none",
                        borderRadius: token.radius.md,
                        fontSize: token.font.md,
                        fontWeight: 600,
                        cursor: "pointer",
                    }}
                >
                    ë‹¤ì‹œ ì‹œë„
                </button>
            </div>
        )

    const renderPage = () => {
        switch (page) {
            case "dashboard":
                return (
                    <DashboardPage
                        stats={processedData.stats}
                        dailyData={processedData.dailyData}
                        exchangeRate={exchangeRate}
                        onOpenAI={() => setShowAI(true)}
                    />
                )
            case "daily":
                return (
                    <DailyPage
                        dailyData={processedData.dailyData}
                        exchangeRate={exchangeRate}
                    />
                )
            case "adtype":
                return (
                    <AdTypePage
                        stats={processedData.stats}
                        dailyData={processedData.dailyData}
                        exchangeRate={exchangeRate}
                    />
                )
            default:
                return (
                    <DashboardPage
                        stats={processedData.stats}
                        dailyData={processedData.dailyData}
                        exchangeRate={exchangeRate}
                        onOpenAI={() => setShowAI(true)}
                    />
                )
        }
    }

    return (
        <div
            style={{
                width: "100%",
                height: "100vh",
                display: "flex",
                background: colors.gray[50],
                fontFamily: "Pretendard, -apple-system, sans-serif",
                overflow: "hidden",
            }}
        >
            <Sidebar current={page} onNavigate={setPage} />
            <div
                style={{
                    flex: 1,
                    height: "100vh",
                    display: "flex",
                    flexDirection: "column",
                    overflow: "hidden",
                }}
            >
                <div
                    className="no-print"
                    style={{
                        display: "flex",
                        justifyContent: "flex-end",
                        alignItems: "center",
                        gap: 12,
                        padding: "12px 20px",
                        flexShrink: 0,
                    }}
                >
                    {lastUpdated && (
                        <span
                            style={{
                                fontSize: token.font.xs,
                                color: colors.gray[400],
                            }}
                        >
                            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:{" "}
                            {new Date(lastUpdated).toLocaleString("ko-KR")}
                        </span>
                    )}
                    <button
                        onClick={fetchData}
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 6,
                            padding: "6px 14px",
                            background: colors.gray[0],
                            border: `1px solid ${colors.gray[200]}`,
                            borderRadius: token.radius.md,
                            color: colors.gray[600],
                            fontSize: token.font.sm,
                            cursor: "pointer",
                        }}
                    >
                        {Icons.refresh}ìºì‹œ ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button
                        onClick={fetchLatestData}
                        disabled={refreshing}
                        style={{
                            display: "flex",
                            alignItems: "center",
                            gap: 6,
                            padding: "6px 14px",
                            background: refreshing
                                ? colors.gray[100]
                                : colors.primary,
                            border: "none",
                            borderRadius: token.radius.md,
                            color: refreshing ? colors.gray[400] : "#fff",
                            fontSize: token.font.sm,
                            fontWeight: 600,
                            cursor: refreshing ? "not-allowed" : "pointer",
                        }}
                    >
                        {refreshing ? (
                            <div
                                style={{
                                    width: 14,
                                    height: 14,
                                    border: "2px solid rgba(255,255,255,0.3)",
                                    borderTopColor: "#fff",
                                    borderRadius: "50%",
                                    animation: "spin 1s linear infinite",
                                }}
                            />
                        ) : (
                            Icons.refresh
                        )}
                        {refreshing ? "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." : "ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°"}
                    </button>
                </div>
                <div
                    style={{
                        flex: 1,
                        padding: "0 20px 20px",
                        overflow: "hidden",
                    }}
                >
                    {renderPage()}
                </div>
            </div>
            <AIInsightModal
                isOpen={showAI}
                onClose={() => setShowAI(false)}
                stats={processedData.stats}
                dailyData={processedData.dailyData}
                exchangeRate={exchangeRate}
            />
        </div>
    )
}

addPropertyControls(FocusPlanetDashboard, {
    apiUrl: {
        type: ControlType.String,
        title: "API URL",
        placeholder: "https://script.google.com/macros/s/.../exec",
    },
    exchangeRate: {
        type: ControlType.Number,
        title: "í™˜ìœ¨ (USDâ†’KRW)",
        defaultValue: 1450,
        min: 1000,
        max: 2000,
        step: 10,
    },
})
